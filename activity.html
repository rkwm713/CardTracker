<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Member Activity Tracker</title>
    <!-- Include the Trello Power-Up client library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      #status { margin-top: 20px; }
      button { font-size: 1em; padding: 10px 15px; }
      #authSection, #activitySection { margin-bottom: 20px; }
    </style>
  </head>
  <body>
    <h2>Member Activity Tracker</h2>
    <!-- Section shown when user must authorize the Power-Up -->
    <div id="authSection" style="display:none;">
      <p>Please authorize this Power-Up to access your board data.</p>
      <button id="authBtn">Login with Trello</button>
    </div>
    <!-- Section shown once user is authorized -->
    <div id="activitySection" style="display:none;">
      <button id="trackBtn">Track Activity Now</button>
      <div id="status"></div>
    </div>

    <script>
      (function(){
        var apiKey = 'b3fe974eb0a783caa600c2f8c3d08c95'; // Your public API key (do not expose your secret)
        var t = TrelloPowerUp.iframe();

        // Retrieves the Trello token from localStorage or from the URL hash.
        function getToken(){
          var token = localStorage.getItem('trelloToken');
          if (!token && window.location.hash){
            var hash = window.location.hash.substring(1); // Remove the '#' character
            var params = new URLSearchParams(hash);
            token = params.get('token');
            if(token){
              localStorage.setItem('trelloToken', token);
              // Clean up the URL hash.
              window.location.hash = '';
            }
          }
          return token;
        }

        // Initiates the OAuth flow by redirecting the user to Trello's authorization page.
        function initiateOAuth(){
          var returnUrl = encodeURIComponent(window.location.href);
          var authUrl = 'https://trello.com/1/authorize' +
                        '?expiration=never' +
                        '&name=Member%20Activity%20Tracker' +
                        '&scope=read' +
                        '&response_type=token' +
                        '&key=' + apiKey +
                        '&return_url=' + returnUrl;
          window.location.href = authUrl;
        }

        var token = getToken();
        if(!token){
          // If no token, show the authorization section.
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('authBtn').addEventListener('click', function(){
            initiateOAuth();
          });
        } else {
          // Token is available; show the activity section.
          document.getElementById('activitySection').style.display = 'block';
          document.getElementById('trackBtn').addEventListener('click', function(){
            this.disabled = true;
            document.getElementById('status').innerText = 'Tracking activity...';

            // Get board context (synchronously).
            var context = t.getContext();
            var boardId = context.board;

            // Build the API URL to fetch board actions.
            // We filter for updateCard actions and request fields: date, type, data, and memberCreator.
            var actionsURL = `https://api.trello.com/1/boards/${boardId}/actions?filter=updateCard&fields=date,type,data,memberCreator&key=${apiKey}&token=${token}`;
            fetch(actionsURL)
              .then(function(response){
                return response.json();
              })
              .then(function(actions){
                // Filter actions where a card was moved between lists.
                var moveActions = actions.filter(function(action){
                  return action.data && action.data.listBefore && action.data.listAfter;
                });
                // Build CSV rows.
                var csvRows = [];
                // Header row.
                var header = ["Member", "Card Name", "From List", "To List", "Date"];
                csvRows.push(header.join(','));

                moveActions.forEach(function(action){
                  // Get member's full name (or fallback to username).
                  var memberName = action.memberCreator.fullName || action.memberCreator.username;
                  // Card details.
                  var cardName = action.data.card ? action.data.card.name : '';
                  var fromList = action.data.listBefore.name;
                  var toList = action.data.listAfter.name;
                  // Format the action date as a local string.
                  var actionDate = new Date(action.date).toLocaleString();
                  // Escape quotes and build CSV row.
                  var row = [
                    '"' + memberName.replace(/"/g, '""') + '"',
                    '"' + cardName.replace(/"/g, '""') + '"',
                    '"' + fromList.replace(/"/g, '""') + '"',
                    '"' + toList.replace(/"/g, '""') + '"',
                    '"' + actionDate.replace(/"/g, '""') + '"'
                  ];
                  csvRows.push(row.join(','));
                });
                var csvContent = csvRows.join('\n');
                // Create a Blob and a download link.
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'member_activity.csv';
                a.innerText = 'Download CSV';
                document.getElementById('status').innerHTML = '';
                document.getElementById('status').appendChild(a);
              })
              .catch(function(err){
                console.error(err);
                document.getElementById('status').innerText = 'Error: ' + err.message;
              });
          });
        }
      })();
    </script>
  </body>
</html>
